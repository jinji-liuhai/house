{% extends 'super/base.html' %}

{% block pageheader %}
订单详情
{% endblock %}

{% block mainbody %}
<div class="box box-danger">
  <div class="box-header with-border">
  </div><!-- /.box-header -->
  <!-- form start -->

  <div class="box-body">
    <form role="form" method="POST" action="{% url 'web:gift_order_detail' client.id %}" enctype="multipart/form-data">
      {% csrf_token %}
     <div class="form-group">
      <label for="exampleInputEmail1">订单信息:</label><br>
      订单id: {{ client.id }}<br>
      订单号: {{ client.order_num }}<br>
      用户id: {{ client.user.id }}<br>
      下单时间: {{ client.created|date:"Y-m-d H:m" }}<br>
      订单状态: {{ client.get_status_display }}<br>
      联系方式: {{ client.user.profile.mobile }}<br>
      订单备注: {{ client.note }}<br>

    </div>
    <hr/>
    <div class="form-group">
      <label for="exampleInputEmail1">商品信息:</label><br>
            {% for order_gift in client.get_order_gift %}
              名称:{{ order_gift.gift.title }}
              <br>
              封面:&nbsp;&nbsp;<img src="{{ order_gift.gift.cover_url }}" width="50" height="50" />
              <br>
              编号:{{ order_gift.gift.id }}
              <br>
              规格:{% for gs in order_gift.gift_specifications %}{{gs.specification_values.name}},{% endfor %}
              <br>
              价格:{{ order_gift.gift_sku.price }}
              <br>
              数量:{{ order_gift.number }}
              <br>
              总额:&yen;{% widthratio order_gift.gift_sku.price 1 order_gift.number %}
              <br>
              {% if not forloop.last %}
              <hr style="border-style: dashed;">
              {% endif %}
            {% endfor %}
    </div>
    <hr/>
    <div class="form-group">
      <label for="exampleInputEmail1">配送信息:</label><br>
        收货人:{{ client.shipping_address.name }}
        <br>
        收货地址:{{ client.shipping_address.address_info }}
        <br>
        收货人电话:{{ client.shipping_address.mobile }}
        <br>
        快递公司:{{ client.delivery_com.name }}
        <br>
        快递单号:{{ client.delivery_num }}
        <br>
    </div>
    <hr/>
    <div class="form-group">
      <label for="exampleInputEmail1">付款信息:</label><br>
        订单总额: {{ client.total_fee }}<br>
        实付金额: {{ client.real_fee }}<br>
        支付平台: {{ client.get_pay_way_display }}<br>
        支付平台交易号: {{ client.charge_id }}<br>
        支付时间: {{ client.pay_time|date:"Y-m-d H:m" }}<br>
    </div>
    <hr/>
    <div class="form-group">
      <a class="btn btn-default pull-left" href="{% url 'web:gift_order_list' %}">返回</a>
      {% if client.status == 9 %}
        <a class="btn btn-info pull-right" id="cancel">取消订单</a>
      {% endif %}
      {% if client.status == 4 %}
        <a class="btn btn-info pull-right" id="receipt">已收货</a>
      {% endif %}
      {% if client.status == 1 %}
        <a class="btn btn-info pull-right" id="delivergoods">发货</a>
      {% endif %}
      {% if client.status == 6 %}
        <a class="btn btn-danger pull-right" id="refund_refuse">退款拒绝</a>
        <a class="btn btn-danger pull-right" id="refund">退款</a>
      {% endif %}
    </div>
  </form>
  </div><!-- /.box-body -->
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">填写物流信息</h4>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <div class="form-group">
          <select class="form-control" id="delivery_id">
              {% for delivery in deliverys %}
                <option value="{{delivery.id}}" 
                  {% if delivery.id == client.delivery_com.id %} selected {% endif %}
                >{{ delivery.name }}</option>
              {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <input class="form-control" type="text" id="delivery_num" name="delivery_num" placeholder="发货单号"/>
        </div>
        <div id="shangjiadiv"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="delivery_commit">确认</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block script %}
<script>
$(function () {
  //剩余 退款
  $('#delivergoods').on('click',function(){
    $('#myModal').modal('toggle');
  })
  $('#cancel').bind('click', function() {
     if(confirm("确定取消订单？"))
     {
        $.ajax({
          method: "GET",
          url: "{% url 'web:gift_order_async_cancel' client.id %}"
        }).done(function( args ) {
          args = JSON.parse(args)
          if (!args.error_code) {
            alert('操作成功')
            window.location.reload()
          };
        })
     }
  });
  $('#receipt').bind('click', function() {
     if(confirm("确定订单收货？"))
     {
        $.get("{% url 'web:gift_order_receipt' client.id %}", function() {
          alert('操作成功')
          window.location.reload()
        },"json");
     }
  });
  $('#refund').bind('click', function() {
     if(confirm("确定退款吗？"))
     {
        $.get("{% url 'web:gift_order_refund' client.id %}", function() {
          alert('操作成功');
          window.location.reload();
        },"json");
     }
  });
  $('#refund_refuse').bind('click', function() {
     if(confirm("确定拒绝退款？"))
     {
        $.get("{% url 'web:gift_order_refund_refuse' client.id %}", function(data) {
          if (data.error_code == 0) {
            alert('操作成功');
            window.location.reload();
          };
        },"json");
     }
  });
  $('#delivery_commit').on('click', function(){
    var delivery_id = $.trim($('#delivery_id').val())
    var delivery_num = $.trim($('#delivery_num').val())
    if (delivery_id == '-1' || !delivery_num) {
      alert('物流信息请填写完整')
      return
    };
    $.post("{% url 'web:gift_order_delivergoods' client.id %}", { delivery_id: delivery_id, delivery_num: delivery_num, csrfmiddlewaretoken: '{{ csrf_token }}' }, function(data) {
      if (data.error_code == 0) {
        $('#myModal').modal('hide');
        window.location.reload()
      }else{
        alert(data.error_msg);
      }
      $('#myModal').modal('hide');
    },"json");
  })
});
</script>
{% endblock %}

{% extends 'super/base.html' %}

{% block pageheader %}
  {% if client.id %}
  编辑{{ zhiya_name }}的枝桠视频
  {% else %}
  新建{{ zhiya_name }}的枝桠视频
  {% endif %}
{% endblock %}

{% block mainbody %}
<div class="box box-danger">
  <div class="box-header with-border">
    <h3 class="box-title">
      {% if client.id %}
      编辑{{ zhiya_name }}的枝桠视频
      {% else %}
      新建{{ zhiya_name }}的枝桠视频
      {% endif %}
    </h3>
  </div><!-- /.box-header -->
  <!-- form start -->

  <div class="box-body">
    <form role="form" method="POST"
      {% if not client.id %}
      action="{% url 'web:zhiya_video_create' zhiya_id %}"
      {% else %}
      action="{% url 'web:zhiya_video_edit' zhiya_id client.id %}"
      {% endif %}
      enctype="multipart/form-data">
      {% csrf_token %}
    <div class="form-group">
      <label for="name">标题</label><br>
      <input type="text" class="form-control" name="title"  value="{{ client.title }}"/>
      {{ error.title_msg|safe }}
    </div>
    <div class="form-group">
      <label for="titlelanguage">题语</label><br>
      <textarea class="form-control" name="titlelanguage">{{ client.titlelanguage }}</textarea>
    </div>
    <div class="form-group">
      <label for="speaker">讲者</label>
      <select class="form-control" name="speaker">
        {% for speaker in speakers %}
          <option value="{{ speaker.id }}" 
            {% if client.speaker and client.speaker.id == speaker.id %}
              selected
            {% endif %}
          >{{ speaker.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="episode">集数</label><br>
      <input type="number" class="form-control" name="episode"  value="{% if not client %}1{% else %}{{ client.episode }}{% endif %}" placeholder="请填入数字"/>
    </div>
    <div class="form-group">
      <label for="additional_play_count">额外播放次数</label><br>
      <input type="number" class="form-control" name="additional_play_count"  value="{% if not client %}0{% else %}{{ client.additional_play_count }}{% endif %}" placeholder="没有请填入0"/>
    </div>
    <div class="form-group">
      <label for="additional_collection_count">额外收藏次数</label><br>
      <input type="number" class="form-control" name="additional_collection_count"  value="{% if not client %}0{% else %}{{ client.additional_collection_count }}{% endif %}" placeholder="没有请填入0"/>
    </div>
    <div class="form-group">
      <label for="additional_share_count">额外分享次数</label><br>
      <input type="number" class="form-control" name="additional_share_count"  value="{% if not client %}0{% else %}{{ client.additional_share_count }}{% endif %}" placeholder="没有请填入0"/>
    </div>
    <div class="form-group clearfix" id="container2">
      <label for="video">视频文件:</label><br/>
      <div>
        <input type="text" class="form-control pull-left" name="video" id="video"  value="{{ client.video }}"  style="width:80%" readonly="readonly"/>
        <button type="button" class="btn btn-default pull-left" style="margin-left: 12px;" id="pickfiles2">选择文件</button>
        <button type="button" class="btn btn-default pull-left" style="margin-left: 12px;" onclick="$('#video').val('')">清空文件</button>
      </div>
    </div>
    <div class="form-group">
      <label for="name">上传进度:</label><br/>
      <div>
        <div class="progress progress-striped" style="margin-top:6px;">
          <div class="progress-bar progress-bar-success" role="progressbar" 
               aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
               id="upload_progress">
               0%
          </div>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label for="video_cover">视频封面图片</label>
      <input type="file" id="video_cover" name="video_cover" />
      <p style="margin-top: 10px;">
        {% if client.video_cover_url and client.id %}
          <img src="{{ client.video_cover_url }}?imageView2/1/w/100/h/100" />
        {% endif %}
      </p>
    </div>
    <input type="hidden" name="status" id="status" value="{% if client.status %}{{ client.status }}{% else %}0{% endif %}"/>
    <div class="form-group">
      <button type="submit" class="btn btn-default pull-left" onclick="$('#status').val(1)">
        存为草稿
      </button>
      <button type="submit" class="btn btn-primary pull-right" onclick="$('#status').val(0)">
        {% if client.id %}
          更新
        {% else %}
          创建
        {% endif %}
      </button>
    </div>
  </form>
  </div><!-- /.box-body -->

  <div class="box-footer">
  </div>
</div>
{% endblock %}
{% block script %}
<script type="text/javascript" src="/static/qiniu-js/qiniu.min.js"></script>
<script type="text/javascript" src="/static/qiniu-js/plupload.full.min.js"></script>
<script>
  $(document).ready(function() {
        //设置上传信息
        var uploader2 = Qiniu.uploader({
            runtimes: 'html5,flash,html4',    //上传模式,依次退化
            browse_button: 'pickfiles2',       //上传选择的点选按钮，**必需**
            uptoken_url: '/admin/uptoken/',            //Ajax请求upToken的Url，**强烈建议设置**（服务端提供）
            // uptoken : '', //若未指定uptoken_url,则必须指定 uptoken ,uptoken由其他程序生成
            unique_names: true, // 默认 false，key为文件名。若开启该选项，SDK为自动生成上传成功后的key（文件名）。
            // save_key: true,   // 默认 false。若在服务端生成uptoken的上传策略中指定了 `sava_key`，则开启，SDK会忽略对key的处理
            domain: 'http://{{qiniu_domain}}',   //bucket 域名，下载资源时用到，**必需**
            get_new_uptoken: false,  //设置上传文件的时候是否每次都重新获取新的token
            container: 'container2',           //上传区域DOM ID，默认是browser_button的父元素，
            max_file_size: '10000mb',           //最大文件体积限制
            max_retries: 3,                   //上传失败最大重试次数
            dragdrop: true,                   //开启可拖曳上传
            drop_element: 'container2',        //拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
            chunk_size: '10000mb',                //分块上传时，每片的体积
            auto_start: true,                 //选择文件后自动上传，若关闭需要自己绑定事件触发上传
            multi_selection: false,           //限制只能上传一个文件
            init: {
                'FilesAdded': function(up, files) {
                    plupload.each(files, function(file) {
                        // 文件添加进队列后,处理相关的事情
                    });
                },
                'BeforeUpload': function(up, file) {
                    // 每个文件上传前,处理相关的事情
                    $('#pickfiles2').prev().val("");
                },
                'UploadProgress': function(up, file) {
                   var percent = up.total.percent + '%';
                   $("#upload_progress").css('width', percent);
                   $("#upload_progress").text(percent);
                },
                'FileUploaded': function(up, file, info) {
                    // 每个文件上传成功后,处理相关的事情
                    var res = JSON.parse(info);
                    $('#pickfiles2').prev().val(res.key);
                },
                'Error': function(up, err, errTip) {
                    //上传出错时,处理相关的事情
                },
                'UploadComplete': function() {
                    //队列文件处理完毕后,处理相关的事情
                },
            }
        });
  });
</script>
{% endblock %}